## 一、光线投射算法
### 1. 算法原理
对屏幕上的每一个像素
1. 从视点出发，通过该像素中心向场景发出一条光线，并求该光线与场景中物体全部交点。
2. 将各交点沿光线方向排序，获得离视点最近的交点。
3. 依据局部光照明模型计算该交点处的光亮度，并将所得光亮度赋值给像素。

### 2. 问题
1. 明暗效果仅仅由第一次相交的物体表面法向方向、材质、视点和光照方向以及光照强度等因素共同决定。
2. 不考虑第二层以及更深层次的光线，不具有阴影、反射、折射等效果。

## 二、光线跟踪算法
### 1. 算法原理
对屏幕上的每一个像素
1. 从视点出发，通过该像素中心向场景发出一条光线，并求离视点最近的交点。
2. 使用局部光照模型计算交点处颜色值。
3. 沿交点处的反射和折射方向对光线进行跟踪（递归）。

### 2. 递归终止条件
1. 光线与环境中任何物体均不相交，或交于纯漫射面。
2. 被跟踪光线返回的光亮度值对像素颜色的贡献很小。
3. 已递归到给定深度。

### 3. 特点
1. 可以表现出阴影，反射，折射等视觉效果。
2. 适用于复杂物体的表示方法。

## 三、光线求交
### 1. 光线的表示
光线的参数表示
$$
P(t)=R_o+t*R_d
$$
其中，Ro=(xo,yo,zo) 为光源，Rd=(xd,yd,zd) 是光线朝向单位向量，t 为光线到达的位置。
在光线正方向上，t>0

### 2. 光线与平面求交
##### 平面方程
$$
H(P)=Ax+By+Cz+D=n\cdot P+D=0
$$

##### 计算光线与平面交点
$$
\left \{ 
\begin{array}{c} 
P(t)=R_o+t*R_d \\ 
n\cdot P(t)+D=0 \\ 
\end{array} 
\right .
$$
解得
$$
t=-(D+n\cdot R_o)/(n\cdot R_d)
$$
最后验算 t>0

### 3. 光线与三角形求交
##### 常用步骤
1. 判断光线是否与三角形所在平面相交
2. 若交点存在，判别交点是否位于三角形内部
这样比较复杂，可以利用重心坐标简化

##### 重心坐标
三角形P0P1P2内任意一点P都可表示为
$$
P = \alpha P_0 + \beta P_1 + \gamma P_2
$$
则 (α, β, γ)被称为P点的重心坐标，且满足
$$
0 \le\alpha,\beta,\gamma\le1,\,\alpha+\beta+\gamma=1
$$
则P点可表示为
$$
P = (1-\beta-\gamma) P_0 + \beta P_1 + \gamma P_2
$$

##### 计算光线与三角形交点
$$
R_o+tR_d=(1-\beta-\gamma) P_0 + \beta P_1 + \gamma P_2
$$
即
$$
(R_d,P_0-P_1,P_0-P_2)
\begin{pmatrix}
t\\
\beta\\
\gamma
\end{pmatrix}
=
P_0-R_o
$$
根据Cramer法则，可以求解t，β，γ。
最后检查
$$
t>0, \,0\le \beta,\gamma\le1,\,\beta+\gamma\le1
$$
保证交点位于三角形内部

### 4. 光线与球面求交
##### 数学方法
球心Pc，半径r，球面的隐式方程
$$
f(P)=||P-P_c||-r=0
$$
计算光线与球面交点
$$
||R_o+tR_d-P_c||-r=0 
$$
化简得
$$
\begin{aligned}
&(R_o+tR_d-P_c)\cdot(R_o+tR_d-P_c)=r^2 \\
&t^2+2t(R_d\cdot (R_o-P_c))+(R_o-P_c)\cdot (R_o-P_c)-r^2=0
\end{aligned}
$$
记为
$$
t^2+2tb+c=0
$$
解为
$$
t=-b\pm\sqrt{b^2-c}
$$
问题：实际上不需要计算被挡住的第二个交点。

##### 几何方法
**(1) 判断光线起点是否在球内部**
计算光线起点到球心的向量
$$
l=P_c-R_o
$$
![[assets/Pasted image 20221129160752.png]]
判断光线起点是否在球内部
$$
\begin{aligned}
位于球内部: l^2<r^2\\
位于球外部: l^2>r^2\\
位于球上:l^2=r^2
\end{aligned}
$$

**(2) 判断光线是否与球相交**
找到光线上距离球心最近的点tp
$$
tp=l\cdot R_d
$$
![[assets/Pasted image 20221129160805.png]]
若 tp<0，光线与球不相交。
求tp与球心的距离d
$$
d^2=l^2-t_p^2
$$
![[assets/Pasted image 20221129160822.png]]
若 d>r，光线与球不相交。

**(3) 求最近的的一个交点**
求tp与交点距离
$$
t'^2=r^2-d^2
$$
求交点t
$$
\begin{aligned}
若光线起点位于球外\,\,t=t_p-t'\\
若光线起点位于球内\,\,t=t_p+t'
\end{aligned}
$$
![[assets/Pasted image 20221129160927.png]]

### 5. 光线与多边形求交
1. 判断光线是否与多边形所在平面相交
2. 若交点存在，判别交点是否位于多边形内部

如何判断交点是否位于多边形内部？
交点检测算法（Jordan曲线定理）

Jordan曲线定理：平面上一个点位于一个多边形内部，当且仅当由该点发出的任何一条射线都与多边形的边界有奇数个交点。

## 四、添加阴影
### 1. 思路
由交点向光源方向投射一道光线，如果这道光线与场景中物体有交点，则该交点属于阴影区域。
计算阴影区域时，只关心是否与物体相交（还要判断遮挡物是否透明），不关注哪个是最近交点。

### 2. 判断阴影
从P向光源L发射一条阴影测试光线R
1. 若R到达L途中与场景中物体不相交，则P受L直接照射，不位于阴影中。
2. 否则，P被某一遮挡物遮挡。
3. 若遮挡物不透明，则P位于阴影中。

### 3. 包含阴影的Phong模型
考虑多个光源
$$
I(P)=K_aI_a+\sum_{i=1}^m(f_i(P)I_i(K_{d_i}(N,L)+K_{s_i}(N,H)^n))
$$
若位于阴影中，漫反射和高光为0
$$
f_i(P)=
\begin{cases}
0&若P未受光源i直接照射\\
1&若P受光源i直接照射
\end{cases}
$$

## 五、走样
### 1. 走样
用离散的量（像素）表示连续的量（图形）而引起的失真。

### 2. 反走样
##### 超采样
1. 把当前分辨率成倍提高，计算像素颜色平均值，然后再把画缩放到当前的显示器上。
2. 有限离散像素点逼近效果不好，用更多采样点逼近得到更好的结果。

##### 自适应超采样
1. 只在当像素在物体边沿时进行超采样。
2. 减少缓存、储存带宽的消耗。

## 六、添加纹理
### 1. 矩形
1. 为矩形四个顶点指定二维纹理坐标。
2. 计算矩形内部与光线的交点的二维纹理坐标（双线性插值）。
3. 使用该纹理坐标在纹理图上查找，根据查找结果赋予交点相应颜色。
<[一篇文章为你讲透双线性插值 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/110754637)>

### 2. 三角网格
1. 为三角面片三个顶点指定二维纹理坐标。
2. 计算三角形与光线的交点的二维纹理坐标，（重心坐标×三个顶点的纹理坐标）。
3. 使用该纹理坐标在纹理图上查找，根据查找结果赋予交点相应颜色。

