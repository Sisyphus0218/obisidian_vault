2020K8009929017 侯昱帆

##### 14.1
现有一个文件系统，在其使用文件缓存的情况下，某个应用创建了一个文件 “/home/OS22/fs03.pdf”，并往该文件中写入了4 KB的数据，请分析该过程需要写几个块？分别写哪几个块？如果在任意时刻发生宕机，会出现哪些不一致？请详细列出所有不一致的情况。（注：假设home和OS22目录都已存在）

**解答**
创建文件 /home/OS22/fs03.pdf，需要写如下 4 个块：
1. inode bitmap
2. fs03.pdf 的 inode
3. OS22 的目录项
4. OS22 的 inode

往 fs03.pdf 中写入 4 KB 的数据，需要写如下 3 个块：
1. data-block bitmap
2. fs03.pdf 的 inode
3. 数据块

所以该过程一共需要写 7 个块。

创建文件 /home/OS22/fs03.pdf 时发生宕机
FS 不一致：四个块中任意一个没有写回都会导致不一致。

往 fs03.pdf 中写入 4 KB 的数据时发生宕机
FS 不一致：data-block bitmap 和 fs03.pdf 的 inode 中有一个没写回。
数据与元数据不一致：fs03.pdf 的 inode 和数据块中有一个没写回。

>创建过程需写入的块（自下而上）
>fs03.pdf 的 inode 块、inode bitmap 块、OS22 目录的数据块、OS22 的 inode 块
>写入过程需写入的块（自下而上）
>fs03.pdf 的数据块、datablock bitmap 块、fs03.pdf 的 inode 块
>如果将二者合并，则写入的块为
>fs03.pdf 的数据块、datablock bitmap 块、fs03.pdf 的 inode 块、inode bitmap 块、OS22 目录的数据块、OS22 的 inode 块
>一致性修改往往是自下而上的写回。
>目的：自上而下访问时，必定看见完整的旧数据或完整的新数据。

##### 14.2 
某个文件系统在磁盘上保存了一个大小为20 KB的文件A，现有一个进程打开文件 A，并调用write函数一次性向文件 A 的文件块0 和文件块1写入新数据。假设该文件系统使用文件缓存，且宕机可能发生在任意时刻。请分析
1. 如果文件系统采用数据日志，宕机恢复后，文件A的内容是什么？请分不同情况讨论(即在什么样的宕机情况下，文件A的内容是什么)；
2. 如果文件系统采用元数据日志，并且采用先改数据再改元数据的方式，宕机恢复后，文件 A 的内容是什么？请分不同情况讨论(即在什么样的宕机情况下，文件 A 的内容是什么)。

**解答**
1. 如果在 commit 前宕机，恢复后，文件A 的内容是旧内容。
	如果在 commit 后宕机，恢复后，文件A 的内容是向块0 和块1 写入新数据后的内容。
	
2. 如果在写数据块前宕机，恢复后，文件A 的内容是旧内容。
	如果在写数据块后、commit 前宕机，恢复后，数据块为新内容，但 inode 未更新，文件A 的内容仍然是旧内容。
	如果在 commit 后宕机，恢复后，文件A 的内容是是向块0 和块1 写入新数据后的内容。

>数据日志：文件 A 的内容，要么为 write 之前的内容，要么为 write 之后的内容。
>元数据日志：先写数据块，再写元数据，文件A的内容有四种情况，
>1. 写块0前宕机，文件内容和inode均未改变。
>2. 写块1前宕机，文件内容部分改变，inode未改变。
>3. 提交日志前宕机，文件内容全改变，inode未改变。
>4. 提交日志后宕机，文件内容全改变，inode改变。
>即使采用一致性修改，只记元数据日志在一次写入多个数据块的情况下，仍然会出现**数据不一致**，即多个块的写入不能保证原子性。
