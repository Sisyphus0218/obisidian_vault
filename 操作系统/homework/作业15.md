2020K8009929017 侯昱帆

##### 15.1 
LFS 的 imap 和 CR 都采用类似数组的结构，下标是 ino 或 imap 块号，每一项保存对应 i-node 或 imap 块的磁盘地址。例如，imap\[k\]记录 ino 为 k 的 i-node 的磁盘地址；CR\[n\]记录第 n 个 imap 块的磁盘地址。假设一个 LFS 的块大小为 4KB，磁盘地址占 4B。如果已经分配了 200 万个 i-node，请问：
1. 该 LFS 的 imap 有多少个块？请给出计算过程；
2. 该 LFS 的 CR 有多少个块？请给出计算过程；
3. 如何查 ino=654321 的 inode 的磁盘地址？请给出查找和计算过程。

**解答**
1. 一个 LFS 块大小为 4KB，磁盘地址 4B，故一个块存储 4KB/4B=1024 个地址
	inode 共 200万个，故 imap有  ⌈(2×10^6)/1024⌉=1954块
2.  CR 有  ⌈1954/1024⌉=2 块
3. ino=654321，对应 imap 的第 ⌈654321/1024⌉=639 块
	第 639块 imap 对应 CR 第 ⌈639/1024⌉=1 块
	故在第 1 块 CR 查找第 639 块 imap 地址，再在第 639 块 imap 查找 inode 地址

>imap块数=(inode数×4B)/块大小
>CR块数=(2×imap块×4B)/块大小
>注意**CR块有两个**，分别在磁盘头和磁盘尾
>
>查找inode时，CR->imap->inode
>查 ino=654321 的 inode 的磁盘地址：
>CR: 654321/(1024×1024)=0
>imap: (654321/1024)mod1024=638
>inode: 654321-1024×638=1009

##### 15.2 
一个 LFS 的块大小为 4KB，segment 大小是 4MB。文件块采用多级索引，即包含 10 个直接指针，以及一、二、三级间接指针各 1 个。每个指向数据块的指针占 4 字节。该 LFS 中已经有一个 10MB的文件 foo，请分析：
1. 给出文件 foo 的文件块索引结构，即文件 foo 使用了哪些指针？
2. 写文件 foo 的第 2560 块（假设它在磁盘块 Ai 中，Ai 为磁盘逻辑块号），需要写哪些块？需要几次 I/O？请给出它们写在磁盘上的顺序；
3. 如果是 Fast FS（其块大小也为4KB），写文件 foo 的第 2560 块，需要写哪些块？需要几次 I/O？
4. 如果是日志文件系统，只记录元数据日志，且日志不采用批量提交，则写文件 foo 的第 2560 块，需要写哪些块？需要几次 I/O？

**解答**
1. foo 10MB，块数为 10MB/4KB=2560
	每个指向数据块的指针占 4B，故一个块的指针数为 4KB/4B=1024 
	foo 的文件块索引结构如下：
	直接指针 10 个
	一级间接指针 1 个，指向的块数为 1024 个
	二级间接指针 1 个，指向的块数为 2560-10-1024=1526
2. 依次写数据块、inode块和imap块。
3. 写bitmap，数据块和inode块
4. 写数据块，inode块和bitmap

>2. 读CR、imap和foo的inode、读2次间址块、写2560块和inode块
>（5次读+1次写：写是顺序写，数据块和inode块一起更新）
>3. 读imap和foo的inode、读2次间址块、写2560块和inode块
>（4次读+2次写：数据块和inode块是分开的，所以需要2次写）
>4. 读imap和foo的inode、读2次间址块、写2560块，写日志（共3次），写inode，清除日志
>（4次读+6次写：写日志包括写日志开始、结束以及将要修改的数据写到磁盘上）