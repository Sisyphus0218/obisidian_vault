2020K8009929017 侯昱帆
（9分）

##### 8.1 
一台机器虚存采用分段机制，物理内存当前的空闲空间如下(按物理地址由小到大的顺序):12MB, 5MB, 18MB, 20MB, 8MB, 9MB, 10MB和15MB。此时要为三个段分配空间(按时间先后顺序): 段A申请12MB，段B申请10MB，段C申请9MB。请分别给出采用Best Fit， Worst Fit，First Fit 和 Next Fit算法下，每次分配成的空闲空间状态(按物理地址由小到大顺序)，以及每次分配所需的比较次数。

**解答**
1. Best Fit
将空闲分区排序，空闲空间5MB, 8MB, 9MB, 10MB, 12MB, 15MB, 18MB, 20MB
A申请12MB，空闲空间5MB, 8MB, 9MB, 10MB, 15MB, 18MB, 20MB
B申请10MB，空闲空间5MB, 8MB, 9MB, 15MB, 18MB, 20MB
C申请9MB，空闲空间5MB, 8MB, 15MB, 18MB, 20MB
比较次数5+4+3=12次

2. Worst Fit
将空闲分区排序，空闲空间20MB, 18MB, 15MB, 12MB, 10MB, 9MB, 8MB, 5MB
A申请12MB，空闲空间8MB, 18MB, 15MB, 12MB, 10MB, 9MB, 8MB, 5MB
B申请10MB，空闲空间8MB, 8MB, 15MB, 12MB, 10MB, 9MB, 8MB, 5MB
C申请9MB，空闲空间8MB, 8MB, 6MB, 12MB, 10MB, 9MB, 8MB, 5MB
比较次数1+2+3=6次

3. First Fit
A申请12MB，空闲空间5MB, 18MB, 20MB, 8MB, 9MB, 10MB, 15MB
B申请10MB，空闲空间5MB, 8MB, 20MB, 8MB, 9MB, 10MB, 15MB
C申请9MB，空闲空间5MB, 8MB, 11MB, 8MB, 9MB, 10MB, 15MB
比较次数1+2+3=6次

4. Next Fit
A申请12MB，空闲空间5MB, 18MB, 20MB, 8MB, 9MB, 10MB, 15MB
B申请10MB，空闲空间5MB, 8MB, 20MB, 8MB, 9MB, 10MB, 15MB
C申请9MB，空闲空间5MB, 8MB, 11MB, 8MB, 9MB, 10MB, 15MB
比较次数1+2+1=4次

>Best Fit 和 Worst Fit 注意排序
>Next Fit：下次分配从当前块开始

##### 8.2 
假设一台计算机使用32-bit的虚拟地址空间和三级页表，虚地址的划分为 8-bit | 6-bit | 6-bit | 12-bit（注：8 bit对应为第一级页表的地址，以此类推）, 请计算：
1. 该计算机系统的页大小是多少？
2. 该三级页表一共能索引多少个页？
3. 现有一个程序的代码段大小为12KB，数据段为20KB，栈大小为4KB，则在使用上述三级页表时，最少需要占用多少个物理页框？最多会占用多少个物理页框？（注：假设程序各段在地址空间中的布局可以自行决定）
4. 在上述（3）中，假设该计算机使用一级页表进行地址空间管理，则（3）中的程序需要占用多少个物理页框？
注：请写出计算过程。

**解答**
1. 页大小为2^12B=4KB
2. 一共能索引2^8×2^6×2^6=2^20个页
3. 代码段占3个物理页框，数据段占5个，栈占1个，共3+5+1=9个物理页框。
	对于页表，若代码段、数据段和栈的页表项处在同一个第三级页表，则只需3个物理页框。
	若代码段、数据段和栈的页表项处在三个不同的第三级页表，且这些页表需要三个不同的第二级页表索引，则需1+3+3=7个物理页框。
	故最少占9+3=12个物理页框，最多占9+7=16个物理页框
4. 1+9=10个物理页框

>（-1）
>3. 最少 1+1+1+9，最多 1+9+9+9
>最少：9个物理页框对应1个三级页表，1个三级页表对应1个二级页表
>最多：9个物理页框对应9个三级页表，9个三级页表对应9个二级页表
>4. 最少1+9，最多9+9

##### 8.3 
假设一台计算机上运行一个进程A，该进程的地址空间大小为4 MB（页大小为4KB）。该计算机使用线性页表记录进程A的虚实映射关系，并且将A的页表都保存在内存中。该计算机CPU的TLB大小为32项，每项4B，一次TLB查询或TLB填充的延迟均为5 ns，请计算：
假设该计算机使用软件处理TLB miss，且操作系统进行一次页表查询的平均延迟为100 ns，如果想让虚实地址映射的平均延迟为40 ns，那么 TLB的命中率应为多少？如果想让虚实地址映射的平均延迟不超过15 ns，那么TLB的命中率应为多少？（上述各项操作的延迟不变）

**解答**
设TLB命中率为x
虚实地址映射的平均延迟为40 ns
则 5x+(1-x)(5+100+5+5)=40  TLB命中率x=68.18%
虚实地址映射的平均延迟为15 ns 
则 5x+(1-x)(5+100+5+5)=15  TLB命中率x=90.90%

>TLB hit: TLB query latency 
>TLB miss: TLB query + page table walk + TLB refill + **TLB query**
>如果TLB miss，完成TLB填充后，会让刚才发生异常的指令再次执行，所以会再次查询TLB。
>一般TLB query和PT walk是串行的。

##### 8.4 
现有如下C程序
```
uint32 X[N];
int step = M, i = 0;
for(i=0; i<N; i+=step) X[i] = X[i] + 1;
```

请计算：
1. 假设该程序运行在一台计算机上，该计算机的虚址空间为32-bit，物理地址空间为2 GB，页大小为4 KB，如果采用一级页表，则该页表的页表项一共有多少？
2. 假设该计算机的CPU的TLB大小为32项，每项4B，那么题述程序中的M和N取值为多少时，会使得程序中循环的每一次执行都会触发TLB miss？（假设TLB初始为空）
3. 在（2）中，M和N取值多少时，会使得程序中的循环执行时TLB hit最多？（假设TLB初始为空）

**解答**
1. 页大小为4 KB=2^12B，故页内偏移12位，则虚页页号32-12=20位，故页表项2^20个。
2. uint32 X\[N\]，故一个X\[i\]大小为4B。
	页大小为4KB，故一个页有4KB/4B=1024个X\[i\]。
	由于TLB初始为空，故若循环中连续访问的X\[i\]在不同页，则每次循环都会触发TLB miss。
	所以M=1024，N可取任意值。
3. M=1，N可取任意值。

>第二问：M≥1024