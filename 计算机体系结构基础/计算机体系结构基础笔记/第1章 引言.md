#计算机体系结构-引言
## 1.1 计算机体系结构的研究内容
### 1.1.1 一以贯之
##### 计算机系统层次
四个层次：应用程序、操作系统、硬件系统、晶体管。
三个界面：应用程序编程接口API、指令系统ISA、工艺模型。

第一个界面是应用程序编程接口 API (Application Programming Interface)，也可以称作“操作系统的指令系统”，介于应用程序和操作系统之间。
API 是应用程序的高级语言编程接口，在编写程序的源代码时使用。常见的 API 包括 C 语言、Fortran 语言、Java 语言、 JavaScript 语言接口以及 OpenGL图形编程接口等。使用一种 API 编写的应用程序经重新编译后可以在支持该 API 的不同计算机上运行。所有应用程序都是通过 API 编出来的，在 IT 产业，谁控制了 API 谁就控制了生态，API 做得好，APP(Application) 就多。API 是建生态的起点。

第二个界面是指令系统 ISA (Instruction Set Architecture)，介于操作系统和硬件系统之间。 
常见的指令系统包括 X86、ARM、 MIPS、 RISC-V 和 LoongArch 等。由于 IT 产业的主要应用都是通过目标码的形态发布的，因此 ISA 是软件兼容的关键, 是生态建设的终点。 

第三个界面是工艺模型，介于硬件系统与晶体管之间。 
工艺模型是芯片生产厂家提供给芯片设计者的界面，除了表达晶体管和连线等基本参数的 SPICE (Simulation Program with Integrated Circuit Emphasis) 模型外，该工艺所能提供的各种 IP 也非常重要，如实现 PCIE 接口的物理层(简称 PHY) 等。

在 API 和 ISA 之间还有一层应用程序二进制接口 ABI (Application Binary Interface)。 ABI 是应用程序访问计算机硬件及操作系统服务的接口，由计算机的用户态指令和操作系统的系统调用组成。
为了实现多进程访问共享资源的安全性，处理器设有“用户态” 与 “核心态”。用户程序在用户态下执行，操作系统向用户程序提供具有预定功能的**系统调用函数**来访问只有核心态才能访问的硬件资源。当用户程序调用系统调用函数时，处理器进入核心态执行诸如访问 IO 设备、修改处理器状态等只有核心态才能执行的指令。处理完系统调用后，处理器返回用户态执行用户代码。相同的应用程序二进制代码可以在相同 ABI 的不同计算机上运行。

![[Pasted image 20221205124830.png]]

### 1.1.3 计算机的基本组成
##### 冯诺依曼结构
本质特征：存储程序和指令驱动执行
目前的计算机没有能突破该特征的，都是对冯诺依曼结构的变种（如哈佛结构、并行结构等）。
优点：自动、快速执行。
缺点：指令驱动的顺序执行、CPU和存储器分开，而且越来越远。

## 1.2 衡量计算机的指标
### 1.2.1 计算机的性能
性能的最本质定义：完成一个任务所需要的时间
时间 = 完成该任务需要的指令数 × 完成每条指令需要的拍数 × 每拍需要的时间
$$
CPU_{time}=IC \times CPI \times Cycle Time
$$
完成任务需要的指令数：与算法、 编译器和指令的功能有关; 
每条指令需要的拍数：与编译器、 指令功能、 微结构设计相关; 
每拍需要的时间（时钟周期）：与结构、 电路设计、 工艺等因素有关

##### 完成任务需要的指令数
1. 算法：对 N 个数进行排序，冒泡排序算法的运算复杂度为 O(N×N)，快速排序算法的运算复杂度为 O(Nlog2N)，如果 N 为 1024，则二者执行的指令数差 100 倍。
2. 编译器：编译器把用户用高级语言 (如 C/ C++) 写的代码转换成一条条指令组成的二进制码。转换出来的目标码的质量的好坏影响完成一个任务的指令数。
3. 指令系统：一条指令能干多少事讲不清楚。 

##### 每条指令需要的拍数
在指令系统确定后，需考虑如何降低每条指令的平均执行周期 (CPI)，或提高每个时钟周期平均执行的指令数 (简称 IPC)。
处理器的微结构设计对 IPC 的影响很大，采用单发射还是多发射结构，采用何种转移猜测策略以及什么样的存储层次设计都直接影响 IPC。

##### 每拍需要的时间（时钟周期）
主频宏观上取决于微结构设计，微观上取决于工艺和电路设计。
微结构设计：Pentium Ⅲ 的流水线是 10 级，Pentium Ⅳ为了提高主频把流水级做到 20 级。Intel 研究表明，把 Cache 和转移猜测表的容量增加一倍，能抵消流水线增加一倍引起的流水线效率降低。
电路设计：甲设计做 64 位加法只要 1ns，而乙设计需要 2ns，那么甲设计比乙设计主频高一倍。 
工艺：先进工艺晶体管速度快，主频高。

##### 总结
在一个系统中不同层次有不同的性能标准，很难用一项单一指标刻画计算机性能的高低。 
从应用的角度看性能也不完全合理。
eg. 甲 2h 算完明天的天气预报，乙计算机 1h。 但也只能说明，针对天气预报这个应用，乙计算机的性能比甲的好。但对于其他应用，甲的性能可能反而比乙的好。

### 1.2.2 计算机的价格
略

### 1.2.3 计算机的功耗
芯片功耗是计算机功耗的重要组成部分。芯片的功耗主要由晶体管工作产生。
功耗=动态功耗+静态功耗
反相器由一个 PMOS 管和一个 NMOS 管组成。 其功耗主要可以分为三类:
1. 开关功耗：电容的充放电。
2. 短路功耗：P 管和 N 管短路时产生的功耗。在反相器开、 闭的转换过程中，电流的变化并不像理论上那样是一个方波，而是有一定的斜率。在这个变化的过程中会出现 N 管和 P 管同时部分打开的情况，这时候就产生了短路功耗。
3. 漏电功耗：MOS 管不能严格关闭时发生漏电产生的功耗。

## 1.4 体系结构设计的基本原则
### 1.4.1 平衡性
##### 木桶原理
一个木桶所盛的水量的多少由最短的木板决定。
一个结构最终体现出的性能受限于其瓶颈部分。

##### 计算性能和访存带宽平衡的经验原则
峰值浮点运算速度 (MFLOPS) 和峰值访存带宽 (MB/ s) 为 1:1 左右。 

##### Amdahl 定律
通过使用某种较快的执行方式所获得的性能的提高，受限于不可使用这种方式提高性能的执行时间所占总执行时间的百分比。
$$
\begin{aligned}
&ExTime_{new} 
= Extime_{old} \times 
((1-Fraction_{enhanced} ) + 
\frac{Fraction_{enhanced}}{Speedup_{enhanced}}) \\
&Speedup_{overall} = Extime_{old} / ExTime_{new}
\end{aligned}
$$
eg. 程序的并行加速比，受限于不能被并行化的串行部分，这些部分将成为程序优化的一个瓶颈。 

### 1.4.2 局部性
##### 事件局部性
有些事件频繁发生, 有些事件不怎么发生, 在这种情况下要重点优化频繁发生的事件。 
eg. 假设把处理器中浮点功能部件执行的性能提高一倍，但是整个程序里面只有 10% 的浮点指令，总的性能加速比是 1÷0. 95 = 1. 053，总的 CPU 性能只提高了 5%。 
所以应该加快经常性事件的速度。 

##### 转移指令跳转方向的局部性
同一条转移指令在执行时经常往同一个方向跳转（硬件转移猜测）。

##### 访存局部性
1. 时间局部性：一个数据被访问后很有可能多次被访问。 
2. 空间局部性：一个数据被访问后，它邻近的数据很有可能被访问。eg. 数组按行访问时相邻的数据连续被访问。高速缓存、TLB、 预取都利用了访存局部性。

### 1.4.3 并行性
##### 指令级并行
1. 时间并行，即指令流水线。指令流水线就像汽车的流水线，不会等一辆汽车都装好以后再开始下一辆汽车的生产，而是在多道工序上同时生产多辆汽车。
2. 空间并行，即多发射。多发射像多车道的马路，乱序执行允许在多车道上超车。

##### 数据级并行
主要指单指令流多数据流 ( SIMD) 的向量结构。例如 X86 中的 AVX 多媒体指令可以用 256 位通路做四个 64 位的运算或八个 32 位的运算。SIMD 作为指令级并行的有效补充，在流媒体领域发挥了重要的作用，现在已经成为通用处理器的标配。

##### 任务级并行
代表是多核处理器以及多线程处理器，是目前计算机体系结构提高性能的主要方法。 

上述三种并行性在现代计算机中都存在。多核处理器运行线程级或进程级并行的程序，每个核采用多发射流水线结构，而且往往有 SIMD 向量部件。

### 1.4.4 虚拟化
虚拟化是体系结构设计者为用户提供一个友好界面的基本方法。
虚拟化的本质：在不好用的硬件和友好的用户界面之间架一座“桥梁”。
1. 操作系统对虚拟地址空间的支持（CPU中实现TLB）（特优）
2. 多发射在维持串行编程模型的情况下提高了速度（优）
3. 多线程和虚拟机技术在单一硬件上虚拟出多个CPU（优）
4. Cache在维持一维的地址空间的情况下提高了速度（良）
5. Cache一致性协议在分布存储的情况下提供统一编程空间（一般）
