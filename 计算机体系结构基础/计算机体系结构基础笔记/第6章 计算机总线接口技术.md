#计算机体系结构-硬件结构
## 6.1 总线概述
总线的本质作用是完成数据交换。
总线用于将两个或两个以上的部件连接起来，使得它们之间可以进行数据交换，或者说通信。
总线含义很广，它不仅仅是指用于数据交换的通道，有时也包含了软件硬件架构。 
比如 PCI 总线、USB 总线，不仅仅是指主板上的某个接口，还包含了与之相对应的整套硬件模型、软件架构。

总线的含义可以分为以下几个层级：
1. 机械层：接口的外形、尺寸、信号排列、连接线的长度范围等。
2. 电气层：信号描述、电源电压、电平标准、信号质量等。
3. 协议层：信号时序、握手规范、命令格式、出错处理等。
4. 架构层：硬件模型、软件架构等。

不同的总线包含的内容也有所不同，有的总线包含以上所有的层级，有的总线可能只包含部分层级。

## 6.2 总线分类
##### 数据传递方向 
1. 单向总线：数据只能从一端传递到另一端，而不能反向传递，也称为单工总线。 
2. 双向总线：数据可以在两个方向上传递，既可以从 A 端传递到 B 端，也可以从 B 端传递到 A 端。也称为双工总线。
	1. 半双工总线是指在一个时间段内, 数据只能从一个方向传送到另一个方向, 数据不能同时在两个方向传递。 
	2. 全双工总线是指数据可以同时在两个方向传递。 全双工总线包含两组数据线, 分别用于两个方向的数据传输。

##### 信号类型 
1. 并行总线：包含多位传输线, 在同一时刻可以传输多位数据。并行总线的优点在于相同频率下总线的带宽更大，但必须保证多位数据在同一时刻到达。这样就会对总线的宽度和频率产生限制，也对主板设计提出了更高的要求。 
2. 串行总线：只使用一位传输线，同一时刻只能传输一位数据，使用编码的方式将时钟频率信息编码在传输的数据之中。 

以串行总线传输方式为基础，使用多条串行总线进行数据传输的方式正在被广泛采用。
多位串行总线与并行总线的根本差别：
1. 多位串行总线：每一个数据通道相对独立传输，独立进行编解码，在接收端恢复数据之后再进行并行数据之间的对齐。
2. 并行总线：使用同一个时钟对所有的数据线进行同时采样，对数据传输线之间的对齐有非常严格的要求。

##### 总线在计算机系统中所处的物理位置
1. 片上总线
2. 内存总线
3. 系统总线
4. 设备总线

## 6.3 片上总线 
片上总线：指芯片片内互连使用的总线。芯片常常分为多个功能模块，这些功能模块之间的连接即采用片上互连总线。 
这些模块形成了IP (Intellectual Property)，这些 IP 的接口使用大家共同遵守的标准时，才能方便使用。因此，芯片的片上互连总线也形成了一定的标准。目前业界公开的主流片上互连总线是 ARM 公司的 AMBA 系列总线。

高级微控制器总线架构 (Advanced Microcontroller Bus Architecture，简称 AMBA) 系列总线包括 AXI、AHB、ASB、APB 等总线。

### AXI 总线
高级可扩展接口 (Advanced eXtensible Interface，简称 AXI) 总线是一种高性能、 高带宽、低延迟的片上总线。 
它的地址/控制和数据总线是分离的，支持不对齐的数据传输，同时在突发传输中只需要发送首地址即可。 
它使用分离的读写数据通道并支持乱序访问。 

AXI 总线主要分为5个独立的通道，分别为写请求、写数据、写响应、读请求、读响应。每个通道采用握手协议独立传输。

AXI 协议包括以下特点：
1. 单向通道体系结构：信息流只以单方向传输, 符合片内设计的要求。
2. 支持多项数据交换：AXI 协议支持的数据宽度很宽，最大可到 1024 位。 通过并行执行突发 (Burst) 操作, 极大地提高了数据吞吐能力，可在更短的时间内完成任务。
3. 独立的地址和数据通道：地址和数据通道分开便于对每一个通道进行单独优化，可以根据需要很容易地插入流水级，有利于实现高时钟频率。

##### AXI 架构
AXI 协议是一个主从协议，每套总线的主设备和从设备是固定好的。 只有主设备才可以发起读写命令。 
一套主从总线包含五个通道：写地址通道、 写数据通道、 写响应通道、 读地址通道、读返回通道。 
读/写地址通道：传送读写目标地址、数据宽度、传输长度和其他控制信息。 
写数据通道：由主设备向从设备传送写数据，AXI 支持带掩码的写操作，可以指定有效数据所在的字节。 
写响应通道：传送写完成信息。 
读返回通道：传送从设备读出的数据以及响应信息。

![[Pasted image 20221211204224.png]]

AXI 协议的一次完整读写过程称为一个总线事务 (Transaction)，传输一个周期的数据称为一次传输 (Transfer)。 
AXI 协议允许地址控制信息在数据传输之前发生，并且支持多个并发访问同时进行，它还允许读写事务的乱序完成。 

AXI 使用双向握手协议，每次传输都需要主从双方给出确认信号。数据的来源方设置有效 (Valid) 信号，数据的接收方设置准备好 (Ready) 信号。只有当 Valid 和 Ready 同时有效时，数据才会传输。 
读请求通道和写数据通道还各包含一个结束 (Last) 信号来指示一次突发传输的最后一个传输周期。

##### 互连架构
在一个使用 AXI 总线的处理器系统中，一般都会包含多个主设备和从设备。这些设备之间使用互连总线进行连接。 
在该互连结构中，任意一个主设备都可以访问所有的从设备。
为了减少互连结构的信号线个数，AXI 的互连结构可以共享地址和数据通道，或者共享地址通道但使用多个数据通道。 
当需要连接的主从设备个数较多时，为了减少互连结构的信号线个数，AXI 协议还可以很方便地支持多层次的互连结构。

![[Pasted image 20221211204353.png]]

##### 高频设计
AXI 协议的每个传输通道都只是单向的信息传递，并且 AXI 协议对多个通道之间的数据传输没有规定特定的顺序关系，多个通道之间没有同步关系。因此，设计者可以很容易地在通道中插入寄存器缓冲，这对于高频设计是很重要的。

##### 基本事务
AXI 协议的主要特点是使用 VALID 和 READY 握手机制进行传输。 地址和数据信息都只在 VALID 和 READY 信号同时为高的情况下才进行传输。

**图 6.5 突发读事务**
请求由主设备发往从设备，响应由从设备发往主设备。 
1. 地址信息在 T2 传输后，主设备从 T4 时刻开始给出读数据 READY 信号；
2. 从设备保持读数据 VALID 信号为低，直到读数据准备好后，才在 T6 时刻将读数据 VALID 信号拉高；
3. 主设备在 T6 时刻接收读数据；
4. 当所有读数据传输完成后，在 T13 时刻，从设备将 RLAST 信号拉高表示该周期是最后一个数据传输。
![[Pasted image 20221211204614.png]]

**图 6.6 重叠的读事务** 
在 T4 时刻，事务 A 的读数据还没有完成传输，从设备就已经接收了读事务 B 的地址信息。 
重叠事务使得从设备可以在前面的数据没有传输完成时就开始处理后面的事务，从而降低后面事务的完成时间。 
AXI 总线上，通过 ID 对不同的事务加以区别。 
同一个读事务的请求与响应中，ARID 与 RID 相同；同一个写事务的请求与响应中，AWID、WID 与 BID 相同。
![[Pasted image 20221211204930.png]]

**图 6.7 写事务**
主从设备在 T2 时刻传输写地址信息，接着主设备将写数据发送给从设备；
在 T9 时刻，所有的写数据传输完毕，从设备在 T10 时刻给出写完成响应信号。
![[Pasted image 20221211205206.png]]

##### 读写事务顺序
AXI 协议支持读写事务乱序完成。 
每一个读写事务都有一个 ID 标签，该标签通过 AXI 信号的 ID 域进行传输。 
同 ID 的读事务或者同 ID 的写事务必须按照接收的顺序按序完成，不同ID 的事务可以乱序完成。 

##### AXI 协议的其他特点
AXI 协议使用分离的读写地址通道，读事务和写事务都包含一个独立的地址通道，用来传输地址和其他控制信息。
AXI 协议支持下列传输机制：
1. 不同的突发传输类型。AXI 支持回绕 (Wrapping)、顺序 (Incrementing) 和固定 (Fix)三种传输方式。回绕传输适合高速缓存行传输，顺序传输适合较长的内存访问，固定传输则适合对外设 FIFO 的访问。
2. 传输长度可变。AXI 协议支持 1 到 16 甚至更多个传输周期。
3. 传输数据宽度可变。支持 8~ 1024 位数据宽度。
4. 支持原子操作。
5. 支持安全和特权访问。
6. 支持错误报告。
7. 支持不对齐访问。

### AHB、 ASB、 APB 总线
AHB、 ASB、 APB 总线是在 AXI 总线之前推出的系统总线。

AHB (Advanced High-performance Bus) 总线是高性能系统总线，它的读写操作共用命令和响应通道，具有突发传输、事务分割、流水线操作、单周期总线主设备切换、非三态实现以及宽数据总线等特点。AHB 协议允许 8 ~ 1024 位的数据总线宽度，但推荐的数据宽度最小为 32 位，最大为 256 位

ASB (Advanced System Bus) 是第一代 AMBA 系统总线，同 AHB 相比，它支持的数据宽度要小一些，典型数据宽度为 8 位、16 位、32位。它的主要特征有：流水线方式, 数据突发传送, 多总线主设备, 内部有三态实现。

APB (Advanced Peripheral Bus) 是本地二级总线 ( Local Secondary Bus)，通过桥和AHB/ ASB 相连。它主要是为了满足不需要高性能流水线接口或不需要高带宽接口的设备间的互连。其主要优点是接口简单、易实现。

片上互连总线的最大特点是高并行性。由于片内走线的距离短，线宽细，因此可以实现高并行性。片上互连总线的设计需要考虑总线的通用性、可扩展性、性能以及总线接口逻辑的设计简单性等方面。

## 6.4 内存总线 
内存总线用于连接处理器和主存储器。内存控制器和内存芯片 (或者说内存条) 的接口就是内存总线。

![[Pasted image 20221211214317.png]]

DRAM 存储单元是按照 Bank、 行、 列来组织的，因此对 DRAM 的寻址是通过 bank 地址、行地址和列地址来进行的。 
计算机系统中可以将多组 DRAM 串接在一起，不同组之间通过片选 (CS) 信号来区分。 
在计算机系统中，程序的地址空间是线性的，处理器发出的内存访问地址也是线性的，由内存控制器负责将地址转换为对应于 DRAM 的片选、Bank 地址、行地址、列地址。

**DDR3 SDRAM 读操作**
图中命令 (Command，简称 CMD) 由 RAS_n、CAS_n 和 WE_n 三个信号组成。 
当 RAS_n 为高电平，CAS_n 为低电平，WE_n 为高电平时，表示一个读命令。 
该图中，列地址信号延迟 (CL) 等于 5 个时钟周期，读延迟 (RL) 等于 5 个时钟周期，突发长度 (Burst Length，BL) 等于 8。 

在当前行已被激活的情况下，读命令在T0时刻发出，经过5个周期，在T5时刻内存芯片开始通过DQ信号返回读数据。
内存芯片在连续4个周期内返回数据，由于DDR内存使用双沿采样，因此一共返回8位数据。
内存在返回数据的同时也驱动DQS信号，DQS信号和DQ信号是完全同步的，内存控制器使用该信号去采样DQ从而捕获DQ的值。DQS信号有一个preamble，供内存控制器过滤出有效时钟。

![[Pasted image 20221211213945.png]]

**DDR3 SDRAM 写操作** 
当 RAS_n 为高电平，CAS_n 为低电平，WE_n 为低电平时，表示一个写操作。
写操作使用额外的数据掩码 (Data Mask，DM) 信号来标识数据是否有效。 
当 DM 为高时，对应时钟沿的数据并不写入 SDRAM，当 DM 为低时，对应时钟沿的数据才写入 SDRAM。
DM 信号与 DQ 信号同步。

在当前行已被激活的情况下，写命令在T0时刻发出，经过5个时钟周期，内存控制器开始输出写数据，同时输出DQS。
数据以burst方式传输，在BL=8的时候持续4个周期。
DQ和DQS的时序是中心对齐的，DQS的上升下降沿对应数据的中心。写DQS同样也有一个preamble。

![[Pasted image 20221211214024.png]]

SDRAM 的基本操作包括激活 (Activate)、 读写 (Read / Write) 和预充电 ( Precharge)。 
当 SDRAM 接收到一个操作后，它需要在固定的时钟周期之后开始进行相应的动作，并且这些动作是需要经过一定的时间才能完成的。 因此，对 DRAM 不同操作命令之间是有时间限制的。 

例如，对于 DDR3-1600 内存来说，当软件访问的两个地址正好位于内存的同一个Bank 的不同行时，
1. 内存控制器需要首先针对第一个访问地址发出激活操作，经过 13.75ns 的时间，才可以发出读写操作。
2. 如果第一个访问是读操作，则需要经过至少 7.5ns (此外还需满足 tRASmin 的要求，这里进行简化说明) 的时间才可以发送预充电操作。
3. 预充电操作发送后, 需要经过 13. 75ns 的时间才可以针对第二个访问的行地址发送新的激活操作, 然后经过 13. 75ns的时间，发送读写操作。 
因此，对 SDRAM 的同一个 Bank 的不同行进行读写存在较大的访问延迟。
为了掩盖访问延迟，SDRAM 允许针对不同 Bank 的操作并发执行。上述访问过程如图 6.15 所示。

![[Pasted image 20221211214103.png]]

提高内存总线访问效率的两个主要手段是：充分利用行缓冲局部性和 Bank 级并行度。
1. 行缓冲局部性：当两个访存命令命中 SDRAM 的同一行时，两个命令可以连续快速发送。
2. Bank级并行度：针对 SDRAM 的不同 Bank 的操作可以并发执行，从而降低后一个操作的访存延迟。 
下面以一个简单的例子来说明对 SDRAM 的不同访问序列的延迟的差别。

假定处理器发出了三个访存读命令，地址分别命中 SDRAM 的
1. 第 0 个 Bank 的第 0 行 (列地址为 0)；
2. 第 0 个 Bank 的第 1 行；
3. 第 0 个 Bank 的第 0 行 (与第一个命令的列地址不同，假定列地址为 1)。 

如果不改变访问的顺序，直接将这三个命令转换为对应 SDRAM 的操作发送给内存，则需要的时间如图 6.16 所示。 
<B0, R0>表示第 0 个 Bank 的第 0 行，<B0, R1>表示第 0 个 Bank 的第 1 行。 
每一个读命令都会转换出对应于 SDRAM 的<激活, 读数据, 预充电>序列。
假定使用的是 DDR2- 800E 规格的内存，时序参数为：
tRCD = 15ns，tRP =15ns，tRASmin = 45ns，tRC= 60ns，tRL = 15ns，tRTP = 7.5ns，tCCD= 10ns (4 个时钟周期)。 
则读数据分别在第 30ns (tRCD+tRL)、90ns (tRC+tRCD+tRL) 和 150ns (tRC+tRC+tRCD+tRL) 返回给处理器。

![[Pasted image 20221211220853.png]]

假定我们改变命令发给内存的顺序，我们将第 3 个命令放到第 1 个命令之后发送，将第 2 个命令最后发送，则得到的访存序列如图 6. 17 所示。 对第 0 个 Bank 第 0 行第 1 列的命令不需要发送预充电和激活操作，而是在对第 0 个 Bank 第 0 行第 0 列的命令之后直接发送。 
处理器得到读数据的时间变为第 30ns、第 40ns 和第 90ns。相比上一种访存序列，第 3 个访存命令的读数据的访存延迟降低了 110ns (40ns 相比于 150ns)。
![[Pasted image 20221211220919.png]]

对内存总线的控制是由内存控制器实现的。内存控制器负责管理内存条的初始化、读写、低功耗控制等操作。内存控制器接收处理器发出的读写命令，将其转化为内存芯片可以识别的DRAM 操作，并负责处理时序相关问题，最终返回数据 (对于读命令) 或者返回一个响应(对于写命令) 给处理器。内存控制器一般还包括命令调度功能，以提高内存总线的访问效率。对于处理器来说，它只需要发送读写命令给内存控制器就可以了，而不必关心内存的状态以及内存是如何被读写的。

## 6.5 系统总线
系统总线通常用于处理器与桥片的连接，同时也作为多处理器间的连接以构成多路系统。
为了提升片间传输性能，系统总线渐渐由并行总线发展为高速串行总线。 

### 6.5.1 HyperTransport 总线 
与并行总线不同的是，串行总线通常采用点对点传输形式，一组串行总线只能连接两个芯片。 

eg. 
龙芯3A2000 / 3A3000 四路互连系统中，共采用 7 组 HT 互连总线，其中 6 组用于四个处理器间的全相联连接，1 组用于处理器与桥片的连接。（图 6.19）
而 PCI 总线则可以在同一组信号上连接多个不同的设备（图 6.20）
![[Pasted image 20221212110644.png]]
![[Pasted image 20221212110700.png]]

HT 总线的软件架构与 PCI 总线协议基本相同，都采用配置空间、IO 空间和 Memory 空间的划分，通过对配置寄存器的设置，采用正向译码的方向对设备空间进行访问。基于 PCI 总线设计的设备驱动程序能够直接使用在 HT 总线的设备上。但在电气特性及信号定义上，HT 总线与 PCI 总线却大相径庭，HT 由两组定义类似但方向不同的信号组成。

HT 总线用于数据传输的信号并非双向信号，而是由两组方向相反的单向信号各自传输，即全双工传输。发送和接收两个方向的传输可以同时进行，互不干扰。 
而采用双向信号的总线，例如 DDR 内存总线或者 PCI 总线，只能进行半双工传输，其发送和接收不能同时进行。而且在较高频率下，发送和接收两种模式需要进行切换时，为了保证其数据传输的完整性，还需要在切换过程中增加专门的空闲周期，这样更加影响了总线传输效率。

HT 总线的读写请求通过包的形式传输，将预先定义好的读写包通过几个连续的时钟周期进行发送，再由接收端进行解析处理。同时, HT 总线采用了流控机制替代了握手机制。

流控机制
在总线初始化完成后，总线双方的发送端将自身的接收端能够接收的请求或响应数通过一种专用的流控包通知对方。
总线双方各自维护一组计数器用于记录该信息。 
1. 每需要发出请求或响应时，先检查对应的计数器是否为 0。
	1. 如果为 0，表示另一方无法再接收这种请求或响应，发送方需要等待；
	2. 如果不为 0，则将对应的计数器值减1，再发出请求或响应。
2. 接收端每处理完一个请求或响应后，会再通过流控包通知对方，对方根据这个信息来增加内部对应的计数器。
通过这种方式，有效消除了总线上的握手，提升了总线传输的频率和效率。

### 6.5.2 HT 包格式
HT 总线的传输以包为单位。
按照传输的类型，分为控制包和数据包两种。 控制包和数据包使用 CTL 信号区分。
1. 当 CTL 信号为高时，表示正在传输一个控制包。
2. 当 CTL 信号为低时，表示正在传输一个数据包。 
数据包依附于最近的一个带数据的控制包。
控制包根据传输的内容，再分为三种不同的包格式，分别为信息包、请求包和响应包。

##### 信息包
信息包的作用是为互连的两端传递底层信息，本身不需要流控。信息包无论何时都是可以被接收并处理的。 
流控信息就是一种典型的信息包。 
![[Pasted image 20221212111456.png]]
其中，“命令” 域用于区分不同的包。对不同的命令，包的其他位置表示的内容之间有所不同。

HT 也是采用 DDR 传输，即双倍数据率传输，在时钟的上升、下降沿各传一组数据。 每种包大小都是 4 字节的倍数。 
图 6.23 是在总线上传输的时序示意图，以 8 位的 CAD 总线为为例。
在 CTL 为高电平的时候，表示传输的是控制包；而 CTL 为低时，表示传输的是数据包。 
图中 CAD 信息上的数字对应包格式表中的具体拍数。
![[Pasted image 20221212111740.png]]

##### 请求包
表 6.5 为请求包的格式。 
因为需要传输地址信息，请求包最少需要 8 字节。 
当使用 64 位地址时，请求包可以扩展至 12 字节。 
大部分请求包地址的 \[7:2\] 是存放在第 3 拍。因为数据的最小单位为 4 字节，地址的 \[1:0\] 不需要进行传输。 
当传输的数据少于 4 字节时，利用数据包的屏蔽位进行处理。
![[Pasted image 20221212111813.png]]
请求包主要是读请求和写请求。其中读请求不需要数据，而写请求需要跟随数据包。

##### 响应包
表 6.6 是响应包的格式。响应包大小为 4 字节。与请求包类似，写响应包不需要数据，而读响应包需要跟随数据包。
![[Pasted image 20221212111835.png]]

##### 数据包
表 6.7 和表 6.8 分别是数据包的两种格式。 
在请求包或响应包中定义了专门的数据长度信息，这个长度以 4 字节为基本单位，最长为 16，也就是 64 字节。 
因此数据包的大小是 4 字节的整数倍，最大为 64 字节。

表 6.7 为不带屏蔽位的数据包格式，最长可以为 64 字节。
![[Pasted image 20221212111902.png]]

表 6.8 为带屏蔽位的数据包格式。前 4 个字节用于定义数据的使能/屏蔽信息，每一位对应一个字节，最多可以为 32 个字节。也就是说，对于带屏蔽位的数据，一个数据包最多传输 32 字节数据。对于数据包，长度最多就是 32+4 个字节。
![[Pasted image 20221212111933.png]]

## 6.6 设备总线 
设备总线用于计算机系统中与 IO 设备的连接。 
PCI (Peripheral Component Interconnect) 总线是一种对计算机体系结构连接影响深远并广泛应用的设备总线。 
PCIE (PCI Express) 可以被看作PCI 总线的升级版本，兼容 PCI 软件架构。 
PCIE  总线被广泛地用作连接设备的通用总线，在现有计算机系统中已经基本取代了 PCI 的位置。 

### 6.6.1 PCIE 总线
与 HT 类似，PCIE 总线也是串行总线。 PCIE 与设备进行连接的时候同样采用点对点的方式，一组 PCIE 接口只能连接一个设备。 为了连接多个设备，就需要实现多个接口，如图 6.25 所示。
![[Pasted image 20221212113332.png]]

与 HT 又有所不同，两者在信号定义和接收发送方法上有很大差别。 
PCIE 在进行传输时，仅仅发送数据信号，而没有发送时钟信号。在接收端通过总线初始化时约定好的数据序列恢复出与发送端同步的时钟，并使用该时钟对接收到的数据信号进行采样，得到原始数据。

### 6.6.2 PCIE 包格式
PCIE 总线的传输同样以包 (事务层包, Transaction Level Packet，简称 TLP) 为单位，其包格式如图 6. 26 所示。 
PCIE 包主要分为 TLP 首部与数据负载两部分，其作用与 HT 包类似，可以对应到 HT 包中的控制包与数据包。 
PCIE 包同样是以 4 字节为单位增长。

![[Pasted image 20221212113451.png]]

对于具体包格式的定义, PCIE 与 HT 各有不同。 尤其是 PCIE 包在协议上最多可以一次传输 4KB 的数据，而 HT 包最多一次传输 64 字节。

PCIE 同样采用了流控机制来消除总线握手。
PCIE 总线被广泛地用作连接设备的设备总线，而 HT 总线则作为系统总线用于处理器与桥片之间的连接及多处理器间的互连。这些使用上的差异是由总线接口特性所决定的。 
与 HT 总线不同的是，PCIE 接口在 x1 时，只有一对发送信号线和一对接收信号线，没有随之发送的时钟和控制信号。 
PCIE 接口通过总线传输编码，将时钟信息从总线上重新提取并恢复数据。 
PCIE 总线的传输相比 HT 总线来说,开销更大，带来延迟的增大及总线带宽利用率的降低。

PCIE 总线可以由多个数据通道组成，每个通道只有一对发送信号和一对接收信号，因此传输时每个通道所使用的信号线更少，而且不同的通道之间相关性小，目前使用的 PCIE 卡最多为 16 个数据通道。对于物理连接来说，PCIE 接口相比 HT 接口，实现更为简单，被广泛地用作可扩展设备连接，逐渐替代了 PCI 总线。