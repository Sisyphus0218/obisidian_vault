1.请给出下列程序在多周期处理器 (如图 9.4 所示) 上执行所需要的时钟周期数，并给出前三次循环执行的时空图。
```
	addi.w t0, zero, 100
LOOP:
	addi.w t0, t0, -1
	bnez   t0, LOOP
```
![[Pasted image 20221210223019.png]]
（完全不流水）
答：
程序指令数目 1+100×2=201（第一条指令+100次循环）
时钟周期数 201×5=1005
![[Pasted image 20221210223244.png]]

2.请给出题 1 中的程序在单发射 5 级静态流水线处理器 (如图 9. 6 所示) 上执行所需要的时钟周期数，并给出前三次循环执行的流水线时空图。
答：
![[Pasted image 20221210223638.png]]

3.请给出题 1 中的程序在包含前递机制的单发射 5 级静态流水线处理器 (如图 9.13 所示) 上执行所需要的时钟周期数，并给出前三次循环执行的流水线时空图。
答：
![[Pasted image 20221210223725.png]]

4.请在图 9. 13 的基础上添加必要的逻辑，使其能够实现精确异常的功能。画出修改后的处理器结构图，并进行解释。
答：
![[Pasted image 20221210223951.png]]

>1. 增加PC例外判断逻辑、译码例外判断逻辑、执行例外判断逻辑、访存例外判断逻辑。
>2. 在译码流水级、执行流水级、访存流水级和写回流水级，加入额外触发器，存储例外信息。每一级例外信息，流水地记录上一级的例外信息和本级新生成的例外信息。
>3. 当指令到达写回流水级时，根据例外信息，如果触发例外，则需要刷写回级、执行级、译码级的流水线；同时更换PC级输入，设定为例外处理函数入口；同时将例外信息存入例外控制寄存器。

5.请给出题 1 中的程序在包含前递机制的双发射 5 级静态流水线处理器 (如图 9. 18 所示) 上执行所需要的时钟周期数，并给出前三次循环执行的流水线时空图。
答：
![[Pasted image 20221210224204.png]]

6.请问数据相关分为哪几种？静态流水线处理器是如何解决这几种相关的？采用寄存器重命名的动态流水线处理器是如何解决这几种相关的？
答：
数据相关分为RAW、WAR、WAW。
静态流水线通过阻塞流水线和前递来解决RAW数据相关，WAR、WAW在静态流水线中不存在。
动态流水线通过保留站解决RAW，通过寄存器重命名解决WAR、WAW。

7.假设在包含前递机制的单发射 5 级静态流水线处理器 (如图 9. 13 所示) 的译码级添加了一个永远预测跳转的静态分支预测器，那么题 1 中的程序在这个处理器上执行需要花费多少时钟周期?
答：
![[Pasted image 20221210225350.png]]

8.对于程序段
```
for(i=0; i<10; i++)
	for(j=0; j<10; j++)
		for(k=0; k<10; k++)
		{…}
```
计算分别使用一位 BHT 表和使用两位 BHT 表进行转移猜测时三重循环的转移猜测准确率，假设 BHT 表的初始值均为 0。
答：
一位BHT表 (8×10×10) / (10×10×10) = 80%
两位BHT表 (7+9×99) / (10×10×10) = 89.8%

[[第9章 指令流水线#9.5.3 转移预测]]

9.在一个 32 位处理器中实现一个 Cache 块大小为 64 字节、总容量为 32KB 的数据 Cache，该数据 Cache 仅使用 32 位物理地址访问。请问，当分别采用直接映射、两路组相联和四路组相联的组织结构时，Cache 访问地址中 Tag、Index 和 Offset 三部分各自如何划分？
答：
Cache 块大小为 64B，则 offset 为 6 位。
总容量为 32KB，则 Cache 块数目为 32KB/64B=2^9
直接映射 Index 为 9 位，Tag 位数 32-9-6=17
两路组相联 Index 为 8 位，Tag 位数 32-8-6=18
两路组相联 Index 为 7 位，Tag 位数 32-7-6=19

[[第9章 指令流水线#访问Cache地址]]

10.假设程序动态执行过程中 load、store 指令占 40%。现在有两种数据 Cache 的设计方案，其中第一种方案的 Cache 容量小于第二种方案，因此采用第一种方案的 Cache 命中率为 85%，第二种方案的 Cache 命中率为 95%，但是采用第二种方案时处理器的主频会比第一种低10%。请问哪种设计方案性能更优？(假设 Cache 不命中情况下会阻塞流水线 100 个时钟周期。)
答：
假设有 N 条指令，load、store 指令 0.4N 条。
方案一主频为 f，方案二主频为 0.9f。
方案一运行时间：{0.4N(1-85%)100+N}/f=7N/f
方案二运行时间：{0.4N(1-95%)100+N}/0.9f=3N/0.9f

>假设该处理器为无相关的单发射处理器
>当cache全部命中时CPI为1（全流水）
>第一种： 1+0.15×0.4×100 = 7
>第二种： (1+0.05×0.4×100)×10/9 = 30/9

***
补充：
1. 在loongarch指令系统中没有延迟槽，所以分支指令后继续按pc+4取值，分支指令执行完如果发现需要跳转则把后面的指令取消并重新取值。
2. 流水线是否前递、分支指令在哪级执行要看具体要求，书上讲述了流水线提高效率的整个过程，包含很多不同的情况。

![[Pasted image 20221213185850.png]]
![[Pasted image 20221213185912.png]]
![[Pasted image 20221213185923.png]]

双发射
1. 为了简化设计，只有同一流水级的两条指令都不被更早的指令阻塞时，才能让这两条指令一起执行；如果两条指令都不被更早的指令阻塞，但slot0阻塞slot1，则slot0先执行。
2. 发生分支取消重取指时，无论分支指令在slot0还是slot1，重取指都能直接取两条指令，按顺序进入slot0和slot1。
